---
layout: post
title: 我是一条数据，今天要搬出MySQL村了
category: 技术
tags: MySQL HBase
keywords: MySQL HBase
description: HBase的故事第一篇
---

注：本文从“码农翻身”公众号的文章得到灵感，尝试从MySQL数据库**订单表**一条数据的角度出发，讲述他从MySQL搬到HBase以及后面发生的故事(需要对HBASE的概念有基本了解)，以解释大数据开发中的一些知识。因能力限制，难免有些错误，还请各位看官斧正。

#### 搬家
---

今天难得周末，我叫了几个老邻居来我这喝茶唠嗑。

“诶，你们听说了吗？”`ls20180208111111111`冷不丁来了这么句。

“听说什么？”我一脸茫然地问。

“你没听到消息啊？我们要搬家了！”`ls20180208111111112`说道。

“啊？为什么要搬？我们在MySQL村住得不挺好的吗？村长人那么好，还有A C I D几大保镖24小时巡逻保护我们。”我有点不解。

“那你没发现现在村子越来越挤了吗？人多就不好管理啊。上次CPU甘哥叫了我们一群兄弟去他那儿，结果你猜怎么着？他们一大帮人整整走了一个星期才到！”`ls20180208111111113`说。

“那阿甘不得气疯了。”阿甘的急性子是出了名的。(参考[CPU阿甘](https://mp.weixin.qq.com/s/qWjoHuPazxKZHbs7j20GYw))

“是啊，按他的时间，他都等了几百年了。”`ls20180208111111113`接着说，“这也没办法，张大胖他们的服务越做越大了，每天都有几千万兄弟新住进MySQL村。虽然我们村有两万平方字节那么大(4T)，但也撑不了多久啊。” (前文[从读写分离到CQRS，张大胖是如何解决性能问题的？](https://mp.weixin.qq.com/s/rpiYZkxiLKa77OFw8XaBwA))

“嗯，那你知道我们要搬去哪儿吗？”我对未知的世界有点恐惧。

“我知道我知道，好像叫HBase小区，听说建了256栋楼给我们住呢。但环境好不好就不清楚了。”`ls20180208111111114`的表情看起来也有点担心。
> 注：HBase会根据大小将表**横向**切分成多个region，这里将一个region比喻成一栋楼

“那只能到时候再看了，希望我们这几个老邻居还能住一块儿。”

“哈哈，希望吧。”大家相处久了都不太愿意分开，毕竟远亲不如近邻啊。

(几天后)

村长：“今天叫大家来呢，是要通知个事，相信最近大伙儿都听到消息说你们要搬新家了，新的小区比这里还要大得多，环境也不错。多余的话我也不说了，反正大伙儿别忘了我这糟老头子就好。新家的门牌号过会儿就快递到了，大家回去签收下就好，东西也不用自己打包，会有搬家公司统一帮大家打包搬运，到时也会有专车接送大家去HBase新小区。”
> 注：门牌号指HBase表的rowKey，相当于MySQL的主键，全表按rowKey排序

虽然大家看起来都有点不舍，但既然村长说了以后的环境比现在要好，也就接受了。大伙儿跟村长告别后便三三两两地回家了。

#### 疑惑
---

过了不久，新家的门牌号到了，我赶紧去找几个邻居看是不是还住一块，结果傻眼了。我住在1区a1栋，`ls20180208111111111`住4区0d栋，`ls20180208111111112`住9区ff栋，`ls20180208111111113`住9区fa栋…… 
> 注：“区”类比的是RegionServer(物理节点)的概念，一个regionServer上管理有多个region

这不全乱套了嘛！难道这也有暗箱操作？故意把我们哥几个分得那么开？我们几个一商量决定去找村长问个明白。

到村长家门口，发现还有其他很多人都在，原来大伙都是类似的情况。

“大伙儿安静下，既然大家都有疑问，那我就给大家说下。”村长拿着喇叭在门口喊。“HBase小区跟我们村不一样，如果按大家现在的顺序照搬过去，会出现一段时间内某栋楼特别拥挤，同时其他楼都没有人的情况，这样很容易发生事故。”
> 注：Region的写入热点，短时间内往一个region中写入大量数据，写入效率严重降低

看大伙眼睛都睁得大大的，一脸懵逼的样子。村长拿出纸和笔给大家画了起来：
![img1](https://raw.githubusercontent.com/bruceFend/brucefend.github.io/master/public/img/hb-01.png)
“由于HBase小区是按照门牌号的顺序来排的，按大家现在的现在的门牌号(流水的拼音首字母加上时间戳，如：`ls20180208111111111`)搬进去，这样`ls`那栋楼的就会非常拥挤，同时其他几栋楼都是空闲状态。等`ls`栋都住不下了，还得临时再建新的大楼。"
> 笔者注：当一个region大小超过阈值时，会分裂成两个，对读写操作有一定影响

“那我们现在的门牌号又是怎么回事？都看不出规律，怕不是你们为了方便暗箱操作，好把海景房分给关系户吧？”有人大声地问。“对，怎么回事？” “这事一定要说清楚” …… 下面的人吵吵闹闹

“咳咳，安静！”村长对这群刁民有点无语，“门牌号的规则，我听说是按`subStr(MD5(account_id + product_code),1,2) + uid`的生成的，这样就可以将大家比较均匀地分在`00`至`ff`栋大楼中，这也是大胖他们为什么提前建好了256栋楼的原因。”
> 注：对HBase表而言，rowKey的设计十分关键，对后期读、写操作的性能影响非常大。而在建HBase表的时候就预先分region，可以一定程度上防止单个region太大而触发拆分操作，影响性能

几个动作快的人，立马计算了起来。

“诶，果然是。”

“对，我的也是”

“那村长，我们分得这么散有什么好处吗？大胖他为什么要整那么麻烦呢？”

“哎，你们都没认真听，都说了HBase小区跟我们不一样。如果按大家现在的门牌号，就算大胖有办法叫来256辆超级加长版林肯，一次性把大家按现在的门牌号都搬到新家去。万一哪天阿甘又叫你们一大帮人过去，是不是又会出现同一栋楼的数据排队出去？到时看阿甘会不会气炸了。”

![img2](https://raw.githubusercontent.com/bruceFend/brucefend.github.io/master/public/img/hb-03.png)
> 注：按原本流水号作为rowKey的方式，读某天或者某个时间段的数据时，同样也会出现热点现象

村长意味深长地说：“一切都是为了部落啊。这样分散开之后，大家从不同的大楼出发，阿甘也不用等你们那么久了。当然门牌号的规则也不一定非得这样，比如把你们现在的门牌号翻转，也能解决问题。再说了，同一个村里的不都是兄弟吗？换个邻居多交些朋友不也挺好的？”
大伙儿相互看了看，纷纷点头表示赞同。
> 注：rowKey的常见设计方案包括：哈希、加盐和翻转

“好了，大家赶紧回去吧。搬家公司今天就到，会替大家打包的。”村长催促大家离开。

#### 打包
---

回去不久果然就有搬家公司的工人来了，为了避免尴尬，我主动跟他聊起来。“哥们，你们是哪个公司的啊？”

“哦，我们是Apache集团下的[Sqoop](http://sqoop.apache.org/)子公司，主要的业务就是做RDBMS村落和Hadoop村落的搬家工作，是ETL行业的大企业。”小伙子自豪地说。

“你们平时业务多吗？”我有点好奇，难道其他人也喜欢搬家？

“还挺多的，尤其现在号称是大数据时代，每个数据库村落住的数据都越来越多，张大胖、李大胖、王大胖他们又有很多不同的需求，所以根据人类不同业务的需要，不少公司都开始将RDBMS部落的数据搬迁到新的部落去。”Sqoop小伙一边帮我打包一边回复道。

这样看来我应该不用太担心房屋的质量、新小区的环境问题了。“诶，我这些家具你为什么要分开打包啊？”我发现Sqoop小伙把我的整个订单信息拆开装进了几个箱子里，用户信息、产品信息和订单详情分别放在三个箱子里面，箱子上标记了`ui`,`pi`和`oi`。
(订单表信息来自: [张大胖学数据库](https://mp.weixin.qq.com/s?__biz=MzAxOTc0NzExNg==&mid=2665513430&idx=1&sn=2cb004652353d08db7f3724c7efd26a1))

![md-03](https://raw.githubusercontent.com/bruceFend/brucefend.github.io/master/public/img/md-03.png)

“哦，张大胖在设计你们新家的时候，设计了3个房间分别给用户信息、产品信息和订单详情住，并采用`Snappy`工艺节省了不少空间使用。”Sqoop小伙习以为常地回答到，一点也不关心我听懂了没有。
> 注：三个标记对应HBase的列簇名，列簇可以理解为一类属性的集合。HBase在纵向根据列簇将表内数据切分，保存在不同文件中。在建表的时候必须包含列簇名，列簇下的列可以自由添加。  
> 而`Snappy`是HBase表常用的压缩算法之一，在压缩比和解压速度上都有不错的表现。

“这样有什么好处吗？”我很不解。  
“当然有啦！想你们在MySQL村住的时候，每条数据房间的结构都是**一模一样**的，要给某一条数据加多一个字段都要大动干戈，而HBase就不同了，每条数据的所有房间都是**完全独立**的，可以随便加，完全不会影响其他数据。”
> 注：HBase表结构松散，类似于HashMap，这个应该算是与MySQL最直观的区别。

虽然有些东西我听不太懂，但以前只有一个房间，现在有三个房间了，应该算是提升了居住环境吧？看来大胖对我们还是不错的，嘻嘻。

#### 离开
---
所有的东西都打包好了，Sqoop分了三次将它们运走。看着越来越模糊的MySQL村和站在大门口的村长，心里各种感触说不上来。一起都重新开始了，我的未来。

(我的自白：我们一大帮数据从MySQL存搬到HBase小区后会发生什么有趣的事，又会遇到哪些意外呢？让我们一起期待作者不要烂尾吧！[手动滑稽~])

#### 扩展阅读

[HBase book](http://hbase.apache.org/book.html#regions.arch)  
[Sqoop教程](https://www.yiibai.com/sqoop/)  
[How to Import Table from MySQL to HBase](https://acadgild.com/blog/how-to-import-table-from-mysql-to-hbase)  
[sqoop将Mysql数据导入Hbase，怎样设置多个族列？](https://bbs.csdn.net/topics/390939913)  
[HBase开启Snappy压缩](http://www.thebigdata.cn/HBase/31380.html)  
[HBase对使用Snappy压缩的表进行Bulkload](http://blog.cheyo.net/203.html)  
[Importance of Compression in HBase - Performance Tuning for HBase - Part 2](https://www.linkedin.com/pulse/importance-compression-hbase-performance-tuning-part-deshpande)  
